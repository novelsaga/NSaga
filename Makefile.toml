[config]
  default_to_workspace = false
  skip_core_tasks      = true

[env]
  ANDROID_ABI                          = "arm64-v8a"
  ANDROID_OUT_DIR                      = "out/android"
  ANDROID_PROJECT_DIR                  = "projects/android"
  ANDROID_TARGET                       = "aarch64-linux-android"
  CARGO_MAKE_EXTEND_WORKSPACE_MAKEFILE = true
  CLI_OUT_DIR                          = "out/cli"
  CLI_PROJECT_DIR                      = "projects/cli"
  OUT_DIR                              = "out"
  WASM_OUT_DIR                         = "out/wasm"
  WASM_PROJECT_DIR                     = "projects/wasm"

  # ==================== WASM ÊûÑÂª∫ ====================

[tasks.wasm]
  description = "Build and optimize WASM package"
  script = '''
#!/usr/bin/env bash
set -euo pipefail

echo "üî® Building NovelSaga WASM..."

# Ê£ÄÊü• wasm-pack
if ! command -v wasm-pack &> /dev/null; then
    echo "‚ùå wasm-pack not found, installing..."
    cargo install wasm-pack
fi

# Ê∏ÖÁêÜÂπ∂ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
rm -rf "${WASM_OUT_DIR}"
mkdir -p "${WASM_OUT_DIR}"

# ÊûÑÂª∫
echo "üì¶ Building with wasm-pack..."
cd "${WASM_PROJECT_DIR}"
wasm-pack build --target web --release --out-dir "../../${WASM_OUT_DIR}"

# ‰ΩøÁî® wasm-opt Ëøõ‰∏ÄÊ≠•‰ºòÂåñ(Â¶ÇÊûúÂèØÁî®)
cd ../..
if command -v wasm-opt &> /dev/null; then
    echo ""
    echo "üîß Optimizing with wasm-opt..."
    wasm-opt -Oz "${WASM_OUT_DIR}/novelsaga_wasm_bg.wasm" -o "${WASM_OUT_DIR}/novelsaga_wasm_bg.wasm.opt"
    mv "${WASM_OUT_DIR}/novelsaga_wasm_bg.wasm.opt" "${WASM_OUT_DIR}/novelsaga_wasm_bg.wasm"
    echo "‚úÖ Optimization complete!"
else
    echo "‚ö†Ô∏è  wasm-opt not found, skipping additional optimization"
fi

echo ""
echo "‚úÖ Build complete!"
echo "üìä Package size:"
du -h "${WASM_OUT_DIR}/novelsaga_wasm_bg.wasm"
'''

  # ==================== Android ÊûÑÂª∫ ====================

[tasks.android]
  description = "Build Android library (aarch64 only)"
  script = '''
#!/usr/bin/env bash
set -euo pipefail

echo "ü§ñ Building NovelSaga Android..."

# Ê∏ÖÁêÜÂπ∂ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
rm -rf "${ANDROID_OUT_DIR}"
mkdir -p "${ANDROID_OUT_DIR}/jniLibs/${ANDROID_ABI}"

echo ""
echo "üî® Building for ${ANDROID_TARGET}..."
cd "${ANDROID_PROJECT_DIR}"
cargo build --target "${ANDROID_TARGET}" --release

# Â§çÂà∂Âà∞ËæìÂá∫ÁõÆÂΩï
cp "../../target/${ANDROID_TARGET}/release/libnovelsaga_android.so" "../../${ANDROID_OUT_DIR}/jniLibs/${ANDROID_ABI}/"

cd ../..
echo "‚úÖ ${ANDROID_TARGET} -> ${ANDROID_OUT_DIR}/jniLibs/${ANDROID_ABI}/libnovelsaga_android.so"

echo ""
echo "‚úÖ Android build complete!"
echo "üìä Library size:"
du -h "${ANDROID_OUT_DIR}/jniLibs/${ANDROID_ABI}/libnovelsaga_android.so"

echo ""
echo "üöÄ Ready to integrate with Android project!"
echo "   Copy ${ANDROID_OUT_DIR}/jniLibs/ to your Android app's src/main/jniLibs/"
'''

  # ==================== CLI Ë∑®Âπ≥Âè∞ÊûÑÂª∫ ====================

[tasks.cli]
  description = "Build CLI for a single target platform"
  script = '''
#!/usr/bin/env bash
set -euo pipefail

# ‰ªéÁéØÂ¢ÉÂèòÈáèËé∑ÂèñÁõÆÊ†áÔºåÂ¶ÇÊûúÊú™ËÆæÁΩÆÂàôÊ†πÊçÆÂΩìÂâçÁ≥ªÁªüÊé®Êñ≠
if [ -z "${CLI_TARGET:-}" ]; then
    case "$(uname -s)-$(uname -m)" in
        Linux-x86_64)
            CLI_TARGET="linux-x64"
            ;;
        Linux-aarch64)
            CLI_TARGET="linux-arm64"
            ;;
        Darwin-x86_64)
            CLI_TARGET="macos-x64"
            ;;
        Darwin-arm64)
            CLI_TARGET="macos-arm64"
            ;;
        *)
            echo "‚ùå Unsupported platform: $(uname -s)-$(uname -m)"
            exit 1
            ;;
    esac
fi

echo "üöÄ Building NovelSaga CLI for $CLI_TARGET..."

# ÁõÆÊ†áÊò†Â∞Ñ
case "$CLI_TARGET" in
    macos-arm64)
        CARGO_TARGET="aarch64-apple-darwin"
        BINARY_NAME="novelsaga"
        ;;
    macos-x64)
        CARGO_TARGET="x86_64-apple-darwin"
        BINARY_NAME="novelsaga"
        ;;
    windows-arm64)
        CARGO_TARGET="aarch64-pc-windows-gnullvm"
        BINARY_NAME="novelsaga.exe"
        ;;
    windows-x64)
        CARGO_TARGET="x86_64-pc-windows-gnu"
        BINARY_NAME="novelsaga.exe"
        ;;
    linux-arm64)
        CARGO_TARGET="aarch64-unknown-linux-gnu"
        BINARY_NAME="novelsaga"
        ;;
    linux-x64)
        CARGO_TARGET="x86_64-unknown-linux-gnu"
        BINARY_NAME="novelsaga"
        ;;
    *)
        echo "‚ùå Unknown target: $CLI_TARGET"
        echo "Available targets: macos-arm64, macos-x64, windows-arm64, windows-x64, linux-arm64, linux-x64"
        exit 1
        ;;
esac

# ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
mkdir -p "${CLI_OUT_DIR}/$CLI_TARGET"

cd "${CLI_PROJECT_DIR}"

echo "üî® Building for $CARGO_TARGET..."

# ‰ΩøÁî® cargo-zigbuild ËøõË°åË∑®Âπ≥Âè∞ÁºñËØë
if cargo zigbuild --release --target "$CARGO_TARGET" 2>&1; then
    cp "../../target/$CARGO_TARGET/release/$BINARY_NAME" "../../${CLI_OUT_DIR}/$CLI_TARGET/" 2>/dev/null || \
    echo "‚ö†Ô∏è  Binary not found for $CARGO_TARGET"

    echo "‚úÖ $CARGO_TARGET -> ${CLI_OUT_DIR}/$CLI_TARGET/"
else
    echo "‚ùå Failed to build for $CARGO_TARGET"
    exit 1
fi

cd ../..

echo ""
echo "‚úÖ CLI build complete!"
echo "üìä Binary size:"
du -h "${CLI_OUT_DIR}/$CLI_TARGET/$BINARY_NAME" 2>/dev/null || true

echo ""
echo "üöÄ Binary ready: ${CLI_OUT_DIR}/$CLI_TARGET/$BINARY_NAME"
'''

[tasks.cli-all]
  description = "Build CLI for all 6 platforms using cargo-zigbuild"
  script = '''
#!/usr/bin/env bash
set -euo pipefail

echo "üöÄ Building NovelSaga CLI for all platforms..."

# Ê∏ÖÁêÜËæìÂá∫ÁõÆÂΩï
rm -rf "${CLI_OUT_DIR}"
mkdir -p "${CLI_OUT_DIR}"

# ÊâÄÊúâÁõÆÊ†áÂπ≥Âè∞
TARGETS=("macos-arm64" "macos-x64" "windows-arm64" "windows-x64" "linux-arm64" "linux-x64")

# Âæ™ÁéØÊûÑÂª∫ÊØè‰∏™Âπ≥Âè∞
for target in "${TARGETS[@]}"; do
    echo ""
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    CLI_TARGET="$target" makers cli
done

echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo "‚úÖ All platforms built successfully!"
echo ""
echo "üìä Binary sizes:"
find "${CLI_OUT_DIR}" -type f \( -executable -o -name "*.exe" \) -exec du -h {} \; 2>/dev/null || true

echo ""
echo "üìÅ Output structure:"
if command -v tree &> /dev/null; then
    tree "${CLI_OUT_DIR}"
else
    find "${CLI_OUT_DIR}" -type f
fi

echo ""
echo "üöÄ Binaries ready for distribution!"
'''

  # ==================== Ê∏ÖÁêÜ‰ªªÂä° ====================

[tasks.clean-wasm]
  description = "Clean WASM build artifacts"
  script = '''
rm -rf "${WASM_OUT_DIR}"
echo "‚úÖ WASM artifacts cleaned"
'''

[tasks.clean-android]
  description = "Clean Android build artifacts"
  script = '''
rm -rf "${ANDROID_OUT_DIR}"
echo "‚úÖ Android artifacts cleaned"
'''

[tasks.clean-cli]
  description = "Clean CLI build artifacts"
  script = '''
rm -rf "${CLI_OUT_DIR}"
echo "‚úÖ CLI artifacts cleaned"
'''

[tasks.clean-all]
  dependencies = ["clean-wasm", "clean-android", "clean-cli"]
  description = "Clean all build artifacts"
  script = '''
cargo clean
rm -rf "${OUT_DIR}"
echo "‚úÖ All artifacts cleaned"
'''

  # ==================== ÁªÑÂêà‰ªªÂä° ====================

[tasks.build-all]
  dependencies = ["wasm", "android", "cli-all"]
  description  = "Build WASM, Android and CLI for all platforms"

[tasks.default]
  description = "Show available tasks"
  script = '''
echo "üìã Available tasks:"
echo ""
echo "  WASM:"
echo "    makers wasm          - Build and optimize WASM"
echo ""
echo "  Android:"
echo "    makers android       - Build Android lib (aarch64 only)"
echo ""
echo "  CLI:"
echo "    makers cli           - Build CLI for current platform"
echo "                           (or specify: makers cli --env CLI_TARGET=linux-x64)"
echo "    makers cli-all       - Build CLI for all 6 platforms (using zigbuild)"
echo ""
echo "  Other:"
echo "    makers build-all     - Build WASM, Android and CLI for all platforms"
echo "    makers clean-all     - Clean all artifacts"
echo ""
'''
