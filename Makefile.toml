[config]
  default_to_workspace = false
  skip_core_tasks      = true

[env]
  ANDROID_ABI                          = "arm64-v8a"
  ANDROID_OUT_DIR                      = "out/android"
  ANDROID_PROJECT_DIR                  = "projects/android"
  ANDROID_TARGET                       = "aarch64-linux-android"
  CARGO_MAKE_EXTEND_WORKSPACE_MAKEFILE = true
  CHANGELOG_FILE                       = "CHANGELOG.md"
  CLI_OUT_DIR                          = "out/cli"
  CLI_PROJECT_DIR                      = "projects/cli"
  OUT_DIR                              = "out"
  WASM_OUT_DIR                         = "out/wasm"
  WASM_PROJECT_DIR                     = "projects/wasm"

  # Cross toolchains (mirrors flake.nix env for consistency)
  AR_aarch64_linux_android       = "aarch64-unknown-linux-android-ar"
  AR_aarch64_pc_windows_gnullvm  = "aarch64-w64-mingw32-ar"
  AR_aarch64_unknown_linux_gnu   = "aarch64-unknown-linux-gnu-ar"
  AR_x86_64_pc_windows_gnu       = "x86_64-w64-mingw32-ar"
  AR_x86_64_unknown_linux_gnu    = "ar"
  CC_aarch64_linux_android       = "aarch64-unknown-linux-android-clang"
  CC_aarch64_pc_windows_gnullvm  = "aarch64-w64-mingw32-clang"
  CC_aarch64_unknown_linux_gnu   = "aarch64-unknown-linux-gnu-gcc"
  CC_x86_64_pc_windows_gnu       = "x86_64-w64-mingw32-gcc"
  CC_x86_64_unknown_linux_gnu    = "gcc"
  CXX_aarch64_linux_android      = "aarch64-unknown-linux-android-clang++"
  CXX_aarch64_pc_windows_gnullvm = "aarch64-w64-mingw32-clang++"
  CXX_aarch64_unknown_linux_gnu  = "aarch64-unknown-linux-gnu-g++"
  CXX_x86_64_pc_windows_gnu      = "x86_64-w64-mingw32-g++"
  CXX_x86_64_unknown_linux_gnu   = "g++"

  # ==================== WASM ÊûÑÂª∫ ====================

[tasks.wasm]
  description = "Build and optimize WASM package"
  script = '''
#!/usr/bin/env bash
set -euo pipefail

echo "üî® Building NovelSaga WASM..."

WASM_OUT_DIR_REAL="$(realpath -m "${WASM_OUT_DIR}")"

# Ê£ÄÊü• wasm-pack
if ! command -v wasm-pack &> /dev/null; then
    echo "‚ùå wasm-pack not found, installing..."
    cargo install wasm-pack
fi

# Ê∏ÖÁêÜÂπ∂ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
rm -rf "${WASM_OUT_DIR_REAL}"
mkdir -p "${WASM_OUT_DIR_REAL}"

# ÊûÑÂª∫
echo "üì¶ Building with wasm-pack (no-install)..."
pushd "${WASM_PROJECT_DIR}" >/dev/null
WASM_BINDGEN="${WASM_BINDGEN:-$(command -v wasm-bindgen || true)}" \
  wasm-pack build --mode no-install --target web --release --out-dir "${WASM_OUT_DIR_REAL}"
popd >/dev/null

# ‰ΩøÁî® wasm-opt Ëøõ‰∏ÄÊ≠•‰ºòÂåñ(Â¶ÇÊûúÂèØÁî®)
if command -v wasm-opt &> /dev/null; then
    echo ""
    echo "üîß Optimizing with wasm-opt..."
  wasm-opt -Oz --enable-bulk-memory "${WASM_OUT_DIR_REAL}/novelsaga_wasm_bg.wasm" -o "${WASM_OUT_DIR_REAL}/novelsaga_wasm_bg.wasm.opt"
  mv "${WASM_OUT_DIR_REAL}/novelsaga_wasm_bg.wasm.opt" "${WASM_OUT_DIR_REAL}/novelsaga_wasm_bg.wasm"
    echo "‚úÖ Optimization complete!"
else
    echo "‚ö†Ô∏è  wasm-opt not found, skipping additional optimization"
fi

echo ""
echo "‚úÖ Build complete!"
echo "üìä Package size:"
du -h "${WASM_OUT_DIR_REAL}/novelsaga_wasm_bg.wasm"
'''

  # ==================== Android ÊûÑÂª∫ ====================

[tasks.android]
  description = "Build Android library (aarch64 only)"
  script = '''
#!/usr/bin/env bash
set -euo pipefail

echo "ü§ñ Building NovelSaga Android..."

# Ê∏ÖÁêÜÂπ∂ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
ANDROID_OUT_DIR_REAL="$(realpath -m "${ANDROID_OUT_DIR}")"
rm -rf "${ANDROID_OUT_DIR_REAL}"
mkdir -p "${ANDROID_OUT_DIR_REAL}/jniLibs/${ANDROID_ABI}"

echo ""
echo "üî® Building for ${ANDROID_TARGET}..."
cd "${ANDROID_PROJECT_DIR}"

TARGET_DIR_REAL="$(realpath -m "${CARGO_TARGET_DIR:-../../target}")"

ANDROID_TRIPLE_ALT="aarch64-unknown-linux-android"
ANDROID_CLANG="${ANDROID_CLANG:-${CC_aarch64_linux_android:-$(command -v ${ANDROID_TRIPLE_ALT}-clang || command -v aarch64-linux-android-clang || true)}}"
ANDROID_AR="${ANDROID_AR:-${AR_aarch64_linux_android:-$(command -v ${ANDROID_TRIPLE_ALT}-ar || command -v aarch64-linux-android-ar || true)}}"

if [ -z "${ANDROID_CLANG}" ] || [ -z "${ANDROID_AR}" ]; then
  echo "‚ùå Android NDK toolchain not found (aarch64-linux-android-clang/ar)"
  exit 1
fi

export CC_aarch64_linux_android="${ANDROID_CLANG}"
export CXX_aarch64_linux_android="${ANDROID_CLANG}++"
export AR_aarch64_linux_android="${ANDROID_AR}"
export CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER="${ANDROID_CLANG}"
export CARGO_TARGET_AARCH64_LINUX_ANDROID_AR="${ANDROID_AR}"

cargo build --target "${ANDROID_TARGET}" --release --target-dir "${TARGET_DIR_REAL}"

# Â§çÂà∂Âà∞ËæìÂá∫ÁõÆÂΩï
cp "${TARGET_DIR_REAL}/${ANDROID_TARGET}/release/libnovelsaga_android.so" "${ANDROID_OUT_DIR_REAL}/jniLibs/${ANDROID_ABI}/"

cd ../..
echo "‚úÖ ${ANDROID_TARGET} -> ${ANDROID_OUT_DIR}/jniLibs/${ANDROID_ABI}/libnovelsaga_android.so"

echo ""
echo "‚úÖ Android build complete!"
echo "üìä Library size:"
du -h "${ANDROID_OUT_DIR}/jniLibs/${ANDROID_ABI}/libnovelsaga_android.so"

echo ""
echo "üöÄ Ready to integrate with Android project!"
echo "   Copy ${ANDROID_OUT_DIR}/jniLibs/ to your Android app's src/main/jniLibs/"
'''

  # ==================== CLI Ë∑®Âπ≥Âè∞ÊûÑÂª∫ ====================

[tasks.cli]
  description = "Build CLI for a single target platform"
  script = '''
#!/usr/bin/env bash
set -euo pipefail

# ‰ªéÁéØÂ¢ÉÂèòÈáèËé∑ÂèñÁõÆÊ†áÔºåÂ¶ÇÊûúÊú™ËÆæÁΩÆÂàôÊ†πÊçÆÂΩìÂâçÁ≥ªÁªüÊé®Êñ≠
if [ -z "${CLI_TARGET:-}" ]; then
    case "$(uname -s)-$(uname -m)" in
        Linux-x86_64)
            CLI_TARGET="linux-x64"
            ;;
        Linux-aarch64)
            CLI_TARGET="linux-arm64"
            ;;
        Darwin-x86_64)
            CLI_TARGET="macos-x64"
            ;;
        Darwin-arm64)
            CLI_TARGET="macos-arm64"
            ;;
        *)
            echo "‚ùå Unsupported platform: $(uname -s)-$(uname -m)"
            exit 1
            ;;
    esac
fi

echo "üöÄ Building NovelSaga CLI for $CLI_TARGET..."

# ÁõÆÊ†áÊò†Â∞Ñ
case "$CLI_TARGET" in
    macos-arm64)
        CARGO_TARGET="aarch64-apple-darwin"
        BINARY_NAME="novelsaga"
        ;;
    macos-x64)
        CARGO_TARGET="x86_64-apple-darwin"
        BINARY_NAME="novelsaga"
        ;;
    windows-arm64)
        CARGO_TARGET="aarch64-pc-windows-gnullvm"
        BINARY_NAME="novelsaga.exe"
        ;;
    windows-x64)
        CARGO_TARGET="x86_64-pc-windows-gnu"
        BINARY_NAME="novelsaga.exe"
        ;;
    linux-arm64)
        CARGO_TARGET="aarch64-unknown-linux-gnu"
        BINARY_NAME="novelsaga"
        ;;
    linux-x64)
        CARGO_TARGET="x86_64-unknown-linux-gnu"
        BINARY_NAME="novelsaga"
        ;;
    *)
        echo "‚ùå Unknown target: $CLI_TARGET"
        echo "Available targets: macos-arm64, macos-x64, windows-arm64, windows-x64, linux-arm64, linux-x64"
        exit 1
        ;;
esac

CLI_OUT_DIR_REAL="$(realpath -m "${CLI_OUT_DIR}")"

# ÂàõÂª∫ËæìÂá∫ÁõÆÂΩï
mkdir -p "${CLI_OUT_DIR_REAL}/$CLI_TARGET"

cd "${CLI_PROJECT_DIR}"

TARGET_DIR_REAL="$(realpath -m "${CARGO_TARGET_DIR:-../../target}")"

echo "üî® Building for $CARGO_TARGET..."

# ‰ΩøÁî® cargo-zigbuild ËøõË°åË∑®Âπ≥Âè∞ÁºñËØë
if cargo zigbuild --release --target "$CARGO_TARGET" --target-dir "${TARGET_DIR_REAL}" 2>&1; then
  artifact="${TARGET_DIR_REAL}/$CARGO_TARGET/release/$BINARY_NAME"
  if [ ! -f "$artifact" ]; then
    echo "‚ùå Built binary missing: $artifact"
    exit 1
  fi
  cp "$artifact" "${CLI_OUT_DIR_REAL}/$CLI_TARGET/"
  echo "‚úÖ $CARGO_TARGET -> ${CLI_OUT_DIR_REAL}/$CLI_TARGET/"
else
    echo "‚ùå Failed to build for $CARGO_TARGET"
    exit 1
fi

cd ../..

echo ""
echo "‚úÖ CLI build complete!"
echo "üìä Binary size:"
du -h "${CLI_OUT_DIR}/$CLI_TARGET/$BINARY_NAME" 2>/dev/null || true

echo ""
echo "üöÄ Binary ready: ${CLI_OUT_DIR}/$CLI_TARGET/$BINARY_NAME"
'''

[tasks.cli-all]
  description = "Build CLI for all 6 platforms using cargo-zigbuild"
  script = '''
#!/usr/bin/env bash
set -euo pipefail

echo "üöÄ Building NovelSaga CLI for all platforms..."

# Ê∏ÖÁêÜËæìÂá∫ÁõÆÂΩï
rm -rf "${CLI_OUT_DIR}"
mkdir -p "${CLI_OUT_DIR}"

# ÊâÄÊúâÁõÆÊ†áÂπ≥Âè∞
TARGETS=("macos-arm64" "macos-x64" "windows-arm64" "windows-x64" "linux-arm64" "linux-x64")

# Âæ™ÁéØÊûÑÂª∫ÊØè‰∏™Âπ≥Âè∞
for target in "${TARGETS[@]}"; do
    echo ""
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    cargo make --env CLI_TARGET="$target" \
               --env CLI_OUT_DIR="${CLI_OUT_DIR}" \
               --env CARGO_TARGET_DIR="${CARGO_TARGET_DIR:-}" \
               cli
done

echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
echo "‚úÖ All platforms built successfully!"
echo ""
echo "üìä Binary sizes:"
find "${CLI_OUT_DIR}" -type f \( -executable -o -name "*.exe" \) -exec du -h {} \; 2>/dev/null || true

echo ""
echo "üìÅ Output structure:"
if command -v tree &> /dev/null; then
    tree "${CLI_OUT_DIR}"
else
    find "${CLI_OUT_DIR}" -type f
fi

echo ""
echo "üöÄ Binaries ready for distribution!"
'''

  # ==================== Ê∏ÖÁêÜ‰ªªÂä° ====================

[tasks.clean-wasm]
  description = "Clean WASM build artifacts"
  script = '''
rm -rf "${WASM_OUT_DIR}"
echo "‚úÖ WASM artifacts cleaned"
'''

[tasks.clean-android]
  description = "Clean Android build artifacts"
  script = '''
rm -rf "${ANDROID_OUT_DIR}"
echo "‚úÖ Android artifacts cleaned"
'''

[tasks.clean-cli]
  description = "Clean CLI build artifacts"
  script = '''
rm -rf "${CLI_OUT_DIR}"
echo "‚úÖ CLI artifacts cleaned"
'''

[tasks.clean-all]
  dependencies = ["clean-wasm", "clean-android", "clean-cli"]
  description = "Clean all build artifacts"
  script = '''
cargo clean
rm -rf "${OUT_DIR}"
echo "‚úÖ All artifacts cleaned"
'''

  # ==================== Changelog ====================

[tasks.changelog]
  description = "Generate or update CHANGELOG.md using git-cliff"
  script = '''
#!/usr/bin/env bash
set -euo pipefail

git-cliff --config cliff.toml --output "${CHANGELOG_FILE}"

echo "‚úÖ Changelog written to ${CHANGELOG_FILE}"
'''

[tasks.changelog-preview]
  description = "Preview unreleased changelog entries"
  script = '''
#!/usr/bin/env bash
set -euo pipefail

git-cliff --config cliff.toml --unreleased
'''

  # ==================== ÁªÑÂêà‰ªªÂä° ====================

[tasks.build-all]
  dependencies = ["wasm", "android", "cli-all"]
  description  = "Build WASM, Android and CLI for all platforms"

[tasks.default]
  description = "Show available tasks"
  script = '''
echo "üìã Available tasks:"
echo ""
echo "  WASM:"
echo "    makers wasm          - Build and optimize WASM"
echo ""
echo "  Android:"
echo "    makers android       - Build Android lib (aarch64 only)"
echo ""
echo "  CLI:"
echo "    makers cli           - Build CLI for current platform"
echo "                           (or specify: makers cli --env CLI_TARGET=linux-x64)"
echo "    makers cli-all       - Build CLI for all 6 platforms (using zigbuild)"
echo ""
echo "  Other:"
echo "    makers build-all     - Build WASM, Android and CLI for all platforms"
echo "    makers clean-all     - Clean all artifacts"
echo ""
echo "  Changelog:"
echo "    makers changelog           - Generate or update ${CHANGELOG_FILE} via git-cliff"
echo "    makers changelog-preview   - Show unreleased entries"
echo ""
'''
